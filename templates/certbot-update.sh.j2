#!/bin/bash

#
# This file was generated by a Ansible role.
#

touch /etc/letsencrypt/list-domain-with-ssl
touch /etc/letsencrypt/list-domain-with-ssl.md5

# Check if exist changes and exit if not
CURRENT_CHECKSUM=$(md5sum /etc/letsencrypt/list-domain-with-ssl | sed 's/ .*//g')
LASTEST_CHECKSUM=$(cat /etc/letsencrypt/list-domain-with-ssl.md5)

if [ "$CURRENT_CHECKSUM" = "$LASTEST_CHECKSUM" ]; then
  echo "Nothing to do. Exiting..."
  exit
fi

# Update checksum
echo ${CURRENT_CHECKSUM} > /etc/letsencrypt/list-domain-with-ssl.md5

# Start renew process
service nginx stop 2>/dev/null

certbot --standalone --non-interactive --agree-tos \
{% for site in loadbalancer_sites %}{% if site.ssl is defined %}{% if site.ssl %}    -d {{site.domain}}  \
{% endif %}{% endif %}{% endfor %}    -m {{acme_email}} --cert-name {{acme_cert_name}} certonly

service nginx start 2>/dev/null
